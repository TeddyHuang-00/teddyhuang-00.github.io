---
import fs from "node:fs";
import { processTypstFile } from "@/utils/generateTypstSvg";

export interface Props {
  filePath: string;
  workspace?: string;
  fontPaths?: string[];
}

const {
  filePath,
  workspace = "src/assets/images",
  fontPaths = [".cache/fonts"],
} = Astro.props;
if (!filePath.endsWith(".typ")) {
  throw new Error("Typst component only supports .typ files");
}
if (!fs.existsSync(filePath)) {
  throw new Error(`Typst file not found: ${filePath}`);
}

// Generate the unique slug/filename base
// We replace slashes with dashes to create a flat filename structure in dist
// This ensures "diagrams/arch.typ" becomes "diagrams-arch"
const slug = filePath
  .replace(workspace, "")
  .replace(/\.typ$/, "")
  .replace(/\//g, " ")
  .trim()
  .replace(/\s+/g, "-");

const { light, dark } = processTypstFile({
  filePath,
  slug,
  workspace,
  fontPaths,
});
---

{
  light === dark ? (
    <figure>
      <img src={light} loading="lazy" decoding="async" class="border-none" />
      {Astro.slots.has("default") && (
        <figcaption class="text-center">
          <slot />
        </figcaption>
      )}
    </figure>
  ) : (
    <>
      <figure class="block dark:hidden">
        <img src={light} loading="lazy" decoding="async" class="border-none" />
        {Astro.slots.has("default") && (
          <figcaption class="text-center">
            <slot />
          </figcaption>
        )}
      </figure>
      <figure class="hidden dark:block">
        <img src={dark} loading="lazy" decoding="async" class="border-none" />
        {Astro.slots.has("default") && (
          <figcaption class="text-center">
            <slot />
          </figcaption>
        )}
      </figure>
    </>
  )
}
