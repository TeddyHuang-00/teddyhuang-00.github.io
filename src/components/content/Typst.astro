---
import fs from "node:fs";
import { NodeCompiler } from "@myriaddreamin/typst-ts-node-compiler";

export interface Props {
  filePath: string;
  workspace?: string;
  fontPaths?: string[];
}

const {
  filePath,
  workspace = "src/assets/images",
  fontPaths = [".cache/fonts"],
} = Astro.props;
if (!filePath.endsWith(".typ")) {
  throw new Error("Typst component only supports .typ files");
}
if (!fs.existsSync(filePath)) {
  throw new Error(`Typst file not found: ${filePath}`);
}

const compiler = NodeCompiler.create({
  workspace,
  fontArgs: [{ fontPaths }],
});
const lightSvg = compiler.svg({
  mainFilePath: filePath,
  inputs: {
    theme: "light",
  },
});
const darkSvg = compiler.svg({
  mainFilePath: filePath,
  inputs: {
    theme: "dark",
  },
});
const notThemed = lightSvg === darkSvg;
---

{
  notThemed ? (
    <figure>
      <Fragment set:html={lightSvg} />
      {Astro.slots.has("default") && (
        <figcaption class="text-center">
          <slot />
        </figcaption>
      )}
    </figure>
  ) : (
    <>
      <figure class="block dark:hidden">
        <Fragment set:html={lightSvg} />
        {Astro.slots.has("default") && (
          <figcaption class="text-center">
            <slot />
          </figcaption>
        )}
      </figure>
      <figure class="hidden dark:block">
        <Fragment set:html={darkSvg} />
        {Astro.slots.has("default") && (
          <figcaption class="text-center">
            <slot />
          </figcaption>
        )}
      </figure>
    </>
  )
}

<style is:global>
  .typst-doc {
    @apply mx-auto max-w-full;
  }
</style>
